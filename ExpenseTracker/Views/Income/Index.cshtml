@model ExpenseTracker.ViewModel.Income.IncomeIndexViewModel
@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers
@using System.Text.Json

@{
    ViewData["Title"] = "Income";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<link rel="stylesheet" href="~/css/Dashboard.css" asp-append-version="true" />
<link rel="stylesheet" href="~/css/Income.css" asp-append-version="true" />

<!-- ========================= PAGE CONTENT ========================= -->
<div class="dashboard-page">

    <!-- ===== INCOME OVERVIEW CHART ===== -->
    <section class="panel income-overview-panel">
        <div class="panel-header">
            <div>
                <h3>Income Overview</h3>
                <p class="panel-subtitle">Track your earnings over time and analyze income trends.</p>
            </div>

            <button type="button"
                    class="chip-button primary"
                    data-bs-toggle="modal"
                    data-bs-target="#addIncomeModal">
                + Add Income
            </button>
        </div>

        <div class="bar-chart-wrapper">
            <canvas id="incomeOverviewChart"></canvas>
        </div>
    </section>

    <!-- ===== INCOME LIST ===== -->
    <section class="panel income-sources-panel">
        <div class="panel-header">
            <h3>Income Sources</h3>
            <a asp-action="Download" class="chip-button">⬇ Download</a>
        </div>

        @if (!Model.IncomeList.Any())
        {
            <div class="empty-state">No income added yet.</div>
        }
        else
        {
            <div class="income-sources-grid">
                @foreach (var income in Model.IncomeList)
                {
                    <div class="income-row">

                        <div class="income-left">
                            <div class="income-icon">
                                @(string.IsNullOrEmpty(income.Icon) ? "💰" : income.Icon)
                            </div>

                            <div class="income-meta">
                                <div class="income-title">@income.Source</div>
                                <div class="income-date">@income.Date.ToString("dd MMM yyyy")</div>
                            </div>
                        </div>

                        <div class="income-right">
                            <span class="income-amount">
                                +@income.Amount.ToString("C0")
                            </span>

                            <!-- EDIT BUTTON -->
                            <button type="button"
                                    class="icon-button text-primary"
                                    data-edit-id="@income.Id"
                                    data-edit-icon="@income.Icon"
                                    data-edit-source="@income.Source"
                                    data-edit-amount="@income.Amount"
                                    data-edit-date="@income.Date.ToString("yyyy-MM-dd")">
                                ✏️
                            </button>

                            <!-- DELETE BUTTON -->
                            <button type="button"
                                    class="icon-button text-danger"
                                    data-delete-id="@income.Id">
                                🗑
                            </button>
                        </div>

                    </div>
                }
            </div>
        }
    </section>

</div>

<!-- ====================== ADD INCOME MODAL ====================== -->
<div class="modal fade" id="addIncomeModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content income-modal">

            <div class="modal-header">
                <h5 class="modal-title">Add Income</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <form asp-action="Add" id="addIncomeForm" method="post">
                @Html.AntiForgeryToken()

                <div class="modal-body">

                    <!-- Icon Picker -->
                    <label class="form-label fw-bold">Pick Icon</label>
                    <div class="emoji-picker mb-3">
                        <label><input type="radio" asp-for="NewIncome.IconEmoji" value="💼"><span>💼</span></label>
                        <label><input type="radio" asp-for="NewIncome.IconEmoji" value="💻"><span>💻</span></label>
                        <label><input type="radio" asp-for="NewIncome.IconEmoji" value="🏦"><span>🏦</span></label>
                        <label><input type="radio" asp-for="NewIncome.IconEmoji" value="🎵"><span>🎵</span></label>
                        <label><input type="radio" asp-for="NewIncome.IconEmoji" value="💰"><span>💰</span></label>
                    </div>

                    <!-- Source -->
                    <div class="form-group mb-3">
                        <label class="form-label fw-bold">Income Source</label>
                        <input asp-for="NewIncome.Source" class="form-control nice-input" placeholder="e.g. Salary, Freelancing">
                    </div>

                    <!-- Amount -->
                    <div class="form-group mb-3">
                        <label class="form-label fw-bold">Amount</label>
                        <input asp-for="NewIncome.Amount"
                               id="amountInput"
                               class="form-control nice-input"
                               inputmode="decimal"
                               placeholder="Enter amount">
                    </div>

                    <!-- Date -->
                    <div class="form-group mb-3">
                        <label class="form-label fw-bold">Date</label>
                        <input asp-for="NewIncome.Date" class="form-control nice-input" type="date">
                    </div>

                </div>

                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary px-4">Add Income</button>
                </div>

            </form>

        </div>
    </div>
</div>

<!-- ====================== EDIT INCOME MODAL ====================== -->
<div class="modal fade" id="editIncomeModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content income-modal">

            <div class="modal-header">
                <h5 class="modal-title">Edit Income</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <form asp-action="Update" method="post">
                @Html.AntiForgeryToken()

                <input type="hidden" name="Id" id="editIncomeId" />

                <div class="modal-body">

                    <!-- Icon Picker -->
                    <label class="form-label fw-bold">Pick Icon</label>
                    <div class="emoji-picker mb-3">
                        <label><input type="radio" name="IconEmoji" value="💼"><span>💼</span></label>
                        <label><input type="radio" name="IconEmoji" value="💻"><span>💻</span></label>
                        <label><input type="radio" name="IconEmoji" value="🏦"><span>🏦</span></label>
                        <label><input type="radio" name="IconEmoji" value="🎵"><span>🎵</span></label>
                        <label><input type="radio" name="IconEmoji" value="💰"><span>💰</span></label>
                    </div>

                    <!-- Source -->
                    <div class="form-group mb-3">
                        <label class="form-label fw-bold">Income Source</label>
                        <input name="Source" id="editSource" class="form-control nice-input" />
                    </div>

                    <!-- Amount -->
                    <div class="form-group mb-3">
                        <label class="form-label fw-bold">Amount</label>
                        <input name="Amount"
                               id="editAmount"
                               class="form-control nice-input"
                               inputmode="decimal" />
                    </div>

                    <!-- Date -->
                    <div class="form-group mb-3">
                        <label class="form-label fw-bold">Date</label>
                        <input name="Date"
                               id="editDate"
                               class="form-control nice-input"
                               type="date" />
                    </div>

                </div>

                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary px-4">Save Changes</button>
                </div>

            </form>

        </div>
    </div>
</div>

<!-- ====================== DELETE MODAL ====================== -->
<div class="modal fade" id="deleteIncomeModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content income-modal">
            <div class="modal-header">
                <h5 class="modal-title">Delete Income</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <form asp-action="Delete" method="post">
                @Html.AntiForgeryToken()
                <input type="hidden" name="id" id="deleteIncomeId" />

                <div class="modal-body">
                    Are you sure you want to delete this income?
                </div>

                <div class="modal-footer">
                    <button type="button" class="chip-button" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="chip-button danger">Delete</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- ====================== SCRIPTS ====================== -->
@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        /* ============================
           CRISP BAR CHART
           ============================ */
        const ctx = document.getElementById('incomeOverviewChart');
        if (ctx) {
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: @Html.Raw(JsonSerializer.Serialize(Model.ChartLabels)),
                    datasets: [{
                        data: @Html.Raw(JsonSerializer.Serialize(Model.ChartData)),
                        backgroundColor: ['#A78BFA', '#8B5CF6', '#6366F1', '#4F46E5'],
                        borderRadius: 10,
                        maxBarThickness: 50
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    devicePixelRatio: 2,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { grid: { display: false }},
                        y: { beginAtZero: true }
                    }
                }
            });
        }

        /* ============================
           DELETE MODAL
           ============================ */
        document.querySelectorAll('[data-delete-id]').forEach(btn => {
            btn.onclick = () => {
                document.getElementById('deleteIncomeId').value = btn.dataset.deleteId;
                new bootstrap.Modal(document.getElementById('deleteIncomeModal')).show();
            };
        });

        /* ============================
           EDIT MODAL PREFILL
           ============================ */
        document.querySelectorAll("[data-edit-id]").forEach(btn => {
            btn.addEventListener("click", function () {

                document.getElementById("editIncomeId").value = this.dataset.editId;
                document.getElementById("editSource").value = this.dataset.editSource;
                document.getElementById("editAmount").value = this.dataset.editAmount;
                document.getElementById("editDate").value = this.dataset.editDate;

                document.querySelectorAll("#editIncomeModal input[name='IconEmoji']")
                    .forEach(r => r.checked = (r.value === this.dataset.editIcon));

                new bootstrap.Modal(document.getElementById("editIncomeModal")).show();
            });
        });
    </script>
}
